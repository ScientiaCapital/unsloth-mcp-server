version: '3.8'

services:
  unsloth-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: unsloth-mcp-server:latest
    container_name: unsloth-mcp

    # For GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    environment:
      # Server config
      - UNSLOTH_SERVER_NAME=unsloth-server
      - UNSLOTH_ENVIRONMENT=production
      - UNSLOTH_LOG_LEVEL=info

      # Cache config
      - UNSLOTH_CACHE_ENABLED=true
      - UNSLOTH_CACHE_TTL=3600

      # Optional: Hugging Face token
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN:-}

    volumes:
      # Persist logs
      - ./logs:/app/logs

      # Persist cache
      - ./cache:/app/.cache

      # Mount models directory (optional)
      - ./models:/app/models

      # Mount datasets directory (optional)
      - ./datasets:/app/datasets

    # MCP uses stdin/stdout, no port mapping needed
    stdin_open: true
    tty: true

    # Restart policy
    restart: unless-stopped

    # Resource limits
    mem_limit: 16g
    memswap_limit: 16g
    shm_size: 2g

  # Optional: Development service with hot reload
  unsloth-mcp-dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: unsloth-mcp-server:dev
    container_name: unsloth-mcp-dev

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    environment:
      - NODE_ENV=development
      - UNSLOTH_LOG_LEVEL=debug

    volumes:
      # Mount source for development
      - ./src:/app/src
      - ./logs:/app/logs
      - ./cache:/app/.cache
      - ./models:/app/models
      - ./datasets:/app/datasets

    command: npm run dev

    stdin_open: true
    tty: true

    profiles:
      - dev
